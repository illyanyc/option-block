<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Option-Block</title>
  <!-- Let browser know website is optimized for mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Compiled and minified Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" integrity="sha256-OweaP/Ic6rsV+lysfyS4h+LM6sRwuO3euTYfr6M124g=" crossorigin="anonymous" />
  <!-- FontAwesome icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous" />
  <!--Custom stylesheet-->
  <link rel="stylesheet" href="style.css" />

</head>

<body class="grey lighten-3">

  <div class="container">

    <img src="https://capsule-render.vercel.app/api?type=waving&color=gradient&width=1000&height=200&section=header&text=Option-Block&fontSize=30&fontColor=black">
    <hr />

    <div class="float-container">
      <div class="float-child">
        <h5>Write Options</h5>
        <!--Write Option-->

        <!--Call or Put Selector-->
        <form action="#">
          <p>
            <label>
              <input name="call_put_switch" type="radio" checked />
              <span>Call</span>
            </label>
          </p>
          <p>
            <label>
              <input name="call_put_switch" type="radio" />
              <span>Put</span>
            </label>
          </p>
        <br>

        <!--Ticker Text Field-->
        <div class="input-field col s6">
          <input type="text" name="ticker_opt" id="ticker_opt" class="validate">
          <label for="ticker_opt">Ticker</label>
        </div>

         <!--Get Stock Price Button-->
         <a class="waves-effect waves-light btn" id="dapp-get-stock-price" onclick="populatePrice()">Get Stock Price from Oracle</a><br>
        <br><br>
  
        <!--Stock Price Text Field-->
        <div class="input-field col s6">
          <input disabled placeholder="$" type="text" name="price" id="price" class="validate">
          <label for="price">Stock Price</label>
        </div>

        <!--Strike Price Text Field-->
        <div class="input-field col s6">
          <input type="text" name="strike" id="strike" class="validate" onchange="setTokenAmount()">
          <label for="strike">Strike Price</label>
        </div>

        <!--Shares Text Field (default: 100)-->
        <div class="input-field col s6">
          <input type="text" name="shares" id="shares" class="validate" value="100" onchange="setTokenAmount()">
          <label for="shares">Shares per Contract</label>
        </div>

        <!--Claculate and set Colleteral-->
        <div class="float-container">
          <div class="float-child">
            Colleteral USD : <input disabled type="number" name="tknAmt-usd" id="tknAmt-usd"><br>
          </div>
          <div class="float-child">
            Colleteral Wei : <input disabled type="number" name="tknAmt-eth" id="tknAmt-eth"><br>
          </div>
        </div>  

        <!--Expiration Date Selector-->
        <label for="expiry">Expiration Date</label>
        <input type="text" class="datepicker" name="expiry" id="expiry">
        
        <!--Get Premiumn Button-->
        <a class="waves-effect waves-light btn" id="dapp-get-premium-price" onclick="getPremium()">Calc. Recommended Premium</a><br>
        <br><br>

        <!--Premium Text Field-->
        <div class="float-container">
          <div class="float-child">
            Premium USD<input type="number" name="premium-usd" id="premium-usd" onchange="setOptionPremiumInEth()"><br>
          </div>
          <div class="float-child">
            Premium Wei<input disabled type="number" name="premium-eth" id="premium-eth"><br>
          </div>
        </div>  

        <!--Write Option Button-->
        <a class="btn waves-effect waves-light" type="submit" id="dapp-write-option" onclick="submitWriteOption()">Write Option</a><br>
        <br><br>

        <!-- Get Eth Price
        <div class="card-action">
          <a id="dapp-get-eth-price" href="#" onclick="dApp.getEthPrice()">Get Eth Price</a>
        </div> -->

       
      </div>

      <div class="float-child">
        <h5>View Optionbook</h5> 
      </div>
    </div>
   



  <!-- JQuery 3.4.1 slim minified -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>
  <!-- Compiled and minified JavaScript for Materialize CSS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js" integrity="sha256-U/cHDMTIHCeMcvehBv1xQ052bPSbJtbuiw4QA9cTKz0=" crossorigin="anonymous"></script>
  <!-- Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.2.5-rc.0/dist/web3.min.js" integrity="sha256-ZjUHyLZZWkQPbWfRjTSmGtfcTSOermVT6f/CvJW2RY4=" crossorigin="anonymous"></script>
  <!-- Materialize Init -->
  <script>
    $(document).ready(function(){
      $('.collapsible').collapsible();
    });

    // Date picker init
    var currDate = new Date();
    $(document).ready(function() {
      $(".datepicker").datepicker({
        // defaultDate: new Date(currDate),
        // setDefaultDate: new Date(2000,01,31),
        minDate: new Date(currDate),
        format: "yyyy-mm-dd",
        autoClose: true
      });
    });

    // Get Stock Price
    function StockPrice(){
       return dApp.getStockPrice(document.getElementById('ticker_opt').value)
    };

    // Populates Stock Price in the text box
    function populatePrice(){
      StockPrice().then(function updatePriceField(_price){
        document.getElementById("price").value = _price;
      })
    };

    // Get Calculated Premium
    async function getPremium(){
      var symbol = document.getElementById("ticker_opt").value;
      var price = document.getElementById("price").value;
      var strike = document.getElementById("strike").value;
      var mat_date = document.getElementById("expiry").value;
      var flag = $("input[name=call_put_switch]:checked").next().text();
      var parsed_flag;
      if (flag == "Call"){
        parsed_flag = "c";
      }else{parsed_flag = "p";};

      // debugging
      console.log("symbol : ".concat(symbol));
      console.log("price : ".concat(price));
      console.log("strike : ".concat(strike));
      console.log("mat_date : ".concat(mat_date));
      console.log("flag : ".concat(parsed_flag));

      // Calculate premium
      var premium = await optionPremium(symbol, price, strike, mat_date, parsed_flag);

      console.log("premium : ".concat(premium));

      // Set textbox to Premium
      document.getElementById("premium-usd").value = premium;
      setOptionPremiumInEth();
    }

    // Calculate premium 
    async function optionPremium(symbol,price,strike,mat_date,flag){
      var _price = String(parseFloat(price) * 100);
      var _strike = String(parseFloat(strike) * 100);
      var url = 'https://option-block.ue.r.appspot.com/option_yf/'+symbol+'/'+_strike+'/'+mat_date+'/'+flag;

      // debug
      console.log(url);

      var premium;
        let obj = await (await fetch(url).then(response => 
          response.json().then(data => ({
              data: data,
              status: response.status
            })
            ).then(res => {
                console.log(res.status, res.data.premium);
                premium = res.data.premium;
            })
          )
        );
      return premium;
    }

    // Set Option Premium in ETH and Set Token Amount
    async function setOptionPremiumInEth(){
      // Set textboc to Premium in ETH
      var premium = document.getElementById("premium-usd").value;
      const premiumInEth = await convertUSDtoETH(premium)
      document.getElementById("premium-eth").value = Math.trunc(premiumInEth * 10**18); 
    }

    // Calculate Token Amount
    async function setTokenAmount(){
      // Get strike price
      const strike = document.getElementById('strike').value;
      // Get Shares
      const shares = document.getElementById('shares').value;
      // Calculate Colletaral in USD
      const tknAmtUSD = strike * shares;
      const tknAmtETH = await convertUSDtoETH(strike * shares)
      document.getElementById("tknAmt-usd").value = tknAmtUSD;
      // Calculate Colleteral in Wei
      document.getElementById("tknAmt-eth").value = Math.trunc(tknAmtETH * 10**18);
    }

    // Update Values
    async function updatePremiumAndToken(){
      setOptionPremiumInEth();
      setTokenAmount();
    }

    // Convert USD to wei
    async function convertUSDtoETH(USD){
      const ethPrice = await dApp.getEthPrice();
      const _ethPrice = ethPrice;
      var priceInEth = USD / _ethPrice;
      return priceInEth
    }

    // Write Option
    async function submitWriteOption(){
      const ethPrice = await dApp.getEthPrice();

      // Get Option flag -> Call or Put
      var flag = $("input[name=call_put_switch]:checked").next().text();
      console.log("flag : ".concat(flag))

      // Get Ticker
      var ticker = document.getElementById('ticker_opt').value;
      console.log("ticker : ".concat(ticker))

      // Get Strike Price
      var strike = document.getElementById('strike').value;
      var strikeEth = convertUSDtoETH(strike) 
      console.log("strike : ".concat(strike))

      // Get Stock Price
      var price = document.getElementById('price').value;
      console.log("price : ".concat(price))

      // Get Number of Shares
      var shares = document.getElementById('shares').value; 
      console.log("shares : ".concat(shares))

      // Get Expiry in Unix timestamp
      var expiry = Math.round(new Date(document.getElementById('expiry').value).getTime()/1000);
      console.log("expiry : ".concat(expiry))

      // Get Premium in Wei
      var premium = document.getElementById("premium-eth").value;
      console.log("premium : ".concat(premium))

      // Get Token Amount
      var tknAmt = document.getElementById('tknAmt-eth').value;
      console.log("tknAmt : ".concat(tknAmt))
      
      if (flag=="Call"){
        await dApp.writeCallOption(strike, premium, shares, expiry, tknAmt, ticker);
      }else if(flag=="Put"){
        await dApp.writePutOption(strike, premium, shares, expiry, tknAmt, ticker);
      }
    };

  </script>
  <!-- dApp JavaScript -->
  <script src="scripts/dapp.js"></script>

</body>
</html>
